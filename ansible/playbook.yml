---
- name: Setup Pipeline Visualizer Infrastructure
  hosts: all
  become: yes
  vars:
    jenkins_user: "{{ jenkins_admin_user | default('admin') }}"
    jenkins_password: "{{ jenkins_admin_pass }}"
    docker_compose_version: "2.23.0"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install basic packages
      apt:
        name:
          - curl
          - wget
          - git
          - unzip
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Install Docker
      block:
        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Start and enable Docker
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Add user to docker group
          user:
            name: "{{ ansible_user }}"
            groups: docker
            append: yes

    - name: Install Jenkins
      block:
        - name: Add Jenkins repository key
          shell: |
            curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | tee /usr/share/keyrings/jenkins-keyring.asc > /dev/null

        - name: Add Jenkins repository
          apt_repository:
            repo: "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/"
            state: present

        - name: Install Jenkins
          apt:
            name: jenkins
            state: present
            update_cache: yes

        - name: Start and enable Jenkins
          systemd:
            name: jenkins
            state: started
            enabled: yes

        - name: Wait for Jenkins to start
          wait_for:
            port: 8080
            delay: 10
            timeout: 300

    - name: Install Node.js and npm
      block:
        - name: Add NodeSource repository
          shell: |
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
          args:
            creates: /etc/apt/sources.list.d/nodesource.list

        - name: Install Node.js
          apt:
            name: nodejs
            state: present
            update_cache: yes

    - name: Install Terraform
      block:
        - name: Download Terraform
          get_url:
            url: "https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip"
            dest: /tmp/terraform.zip
            mode: '0644'

        - name: Unarchive Terraform
          unarchive:
            src: /tmp/terraform.zip
            dest: /usr/local/bin
            remote_src: yes
            creates: /usr/local/bin/terraform

        - name: Make Terraform executable
          file:
            path: /usr/local/bin/terraform
            mode: '0755'

    - name: Configure firewall
      ufw:
        rule: allow
        name: "{{ item }}"
      loop:
        - OpenSSH
        - "Nginx Full"
        - "Jenkins"
      ignore_errors: yes

    - name: Create application directory
      file:
        path: /opt/pipeline-visualizer
        state: directory
        mode: '0755'

    - name: Display Jenkins initial admin password
      debug:
        msg: |
          Jenkins initial admin password can be found at:
          /var/lib/jenkins/secrets/initialAdminPassword
          
          Jenkins URL: http://{{ ansible_default_ipv4.address }}:8080

